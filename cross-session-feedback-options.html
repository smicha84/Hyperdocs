<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cross-Session Feedback â€” Design Options</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif&family=JetBrains+Mono:wght@400;500;600&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --font-display: 'Instrument Serif', 'Georgia', serif;
    --font-body: 'DM Sans', system-ui, sans-serif;
    --font-mono: 'JetBrains Mono', 'SF Mono', Consolas, monospace;
    --bg: #faf9f7; --surface: #ffffff; --surface2: #f5f3f0; --surface3: #ede9e4;
    --border: rgba(0,0,0,0.06); --border-bright: rgba(0,0,0,0.12);
    --text: #1a1a1a; --text-dim: #6b6b6b;
    --accent: #2563eb; --accent-dim: rgba(37,99,235,0.06);
    --green: #16a34a; --green-dim: rgba(22,163,74,0.06);
    --amber: #d97706; --amber-dim: rgba(217,119,6,0.06);
    --red: #dc2626; --red-dim: rgba(220,38,38,0.06);
    --purple: #7c3aed; --purple-dim: rgba(124,58,237,0.06);
    --cyan: #0891b2; --cyan-dim: rgba(8,145,178,0.06);
  }
  @media (prefers-color-scheme: dark) {
    :root {
      --bg: #111111; --surface: #1a1a1a; --surface2: #222222; --surface3: #2a2a2a;
      --border: rgba(255,255,255,0.06); --border-bright: rgba(255,255,255,0.12);
      --text: #e5e5e5; --text-dim: #888888;
      --accent: #60a5fa; --accent-dim: rgba(96,165,250,0.1);
      --green: #34d399; --green-dim: rgba(52,211,153,0.1);
      --amber: #fbbf24; --amber-dim: rgba(251,191,36,0.1);
      --red: #f87171; --red-dim: rgba(248,113,113,0.1);
      --purple: #a78bfa; --purple-dim: rgba(167,139,250,0.1);
      --cyan: #22d3ee; --cyan-dim: rgba(34,211,238,0.1);
    }
  }
  * { margin:0; padding:0; box-sizing:border-box; min-width:0; }
  body { background:var(--bg); color:var(--text); font-family:var(--font-body); line-height:1.65; padding:40px 24px 80px; overflow-wrap:break-word; }
  .container { max-width:1000px; margin:0 auto; }

  h1 { font-family:var(--font-display); font-size:44px; font-weight:400; letter-spacing:-0.5px; line-height:1.1; margin-bottom:8px; }
  .subtitle { font-size:18px; color:var(--text-dim); margin-bottom:32px; }

  /* Callout */
  .callout { background:var(--surface); border:1px solid var(--border); border-left:3px solid var(--red); border-radius:8px; padding:16px 20px; margin-bottom:28px; font-size:14px; line-height:1.7; }
  .callout.rec { border-left-color:var(--green); background:var(--green-dim); }
  .callout strong { color:var(--text); }
  .callout code { font-family:var(--font-mono); font-size:12px; background:var(--surface2); padding:1px 5px; border-radius:3px; }

  /* Broken flow */
  .flow { display:flex; align-items:center; gap:0; flex-wrap:wrap; margin-bottom:32px; padding:20px; background:var(--surface); border:1px solid var(--border); border-radius:12px; }
  .flow-step { padding:8px 14px; border-radius:6px; font-family:var(--font-mono); font-size:12px; font-weight:600; white-space:nowrap; }
  .flow-step.ok { background:var(--green-dim); color:var(--green); }
  .flow-step.blind { background:var(--amber-dim); color:var(--amber); }
  .flow-step.dead { background:var(--red-dim); color:var(--red); }
  .flow-arrow { padding:0 6px; color:var(--text-dim); font-size:16px; flex-shrink:0; }
  .flow-label { font-size:11px; color:var(--text-dim); margin-left:8px; font-style:italic; }

  /* Section head */
  .sec-head { font-family:var(--font-mono); font-size:12px; text-transform:uppercase; letter-spacing:1.5px; color:var(--text-dim); padding:10px 0; margin-top:48px; margin-bottom:20px; border-bottom:1px solid var(--border-bright); }

  /* Option card */
  .option { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:28px; margin-bottom:24px; position:relative; overflow:hidden; }
  .option::before { content:''; position:absolute; top:0; left:0; right:0; height:3px; }
  .option.a::before { background:var(--accent); }
  .option.b::before { background:var(--purple); }
  .option.c::before { background:var(--amber); }
  .option.d::before { background:var(--cyan); }
  .option h2 { font-family:var(--font-display); font-size:28px; font-weight:400; margin-bottom:4px; }
  .option .tag { font-family:var(--font-mono); font-size:11px; font-weight:600; padding:2px 8px; border-radius:4px; display:inline-block; margin-bottom:16px; }
  .option.a .tag { background:var(--accent-dim); color:var(--accent); }
  .option.b .tag { background:var(--purple-dim); color:var(--purple); }
  .option.c .tag { background:var(--amber-dim); color:var(--amber); }
  .option.d .tag { background:var(--cyan-dim); color:var(--cyan); }
  .option .how { font-size:15px; color:var(--text); margin-bottom:20px; line-height:1.7; }
  .option .grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px; }
  @media (max-width:700px) { .option .grid { grid-template-columns:1fr; } }
  .detail-box { background:var(--surface2); border-radius:8px; padding:14px 16px; }
  .detail-box h4 { font-family:var(--font-mono); font-size:11px; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-dim); margin-bottom:8px; }
  .detail-box ul { list-style:none; font-size:13px; line-height:1.7; }
  .detail-box li { padding:2px 0; position:relative; padding-left:16px; }
  .detail-box li::before { content:''; position:absolute; left:0; top:10px; width:6px; height:6px; border-radius:50%; background:var(--border-bright); }
  .detail-box li.pro::before { background:var(--green); }
  .detail-box li.con::before { background:var(--red); }
  .detail-box code { font-family:var(--font-mono); font-size:11px; background:var(--surface); padding:1px 5px; border-radius:3px; }
  .cost-badge { font-family:var(--font-mono); font-size:13px; font-weight:600; padding:4px 12px; border-radius:6px; display:inline-block; margin-bottom:16px; margin-left:12px; }
  .cost-free { background:var(--green-dim); color:var(--green); }
  .cost-low { background:var(--amber-dim); color:var(--amber); }
  .cost-high { background:var(--red-dim); color:var(--red); }

  /* Comparison table */
  .table-wrap { overflow-x:auto; border:1px solid var(--border); border-radius:12px; background:var(--surface); margin-bottom:28px; }
  table { width:100%; border-collapse:collapse; font-size:13px; }
  thead th { background:var(--surface2); font-family:var(--font-mono); font-size:10px; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-dim); padding:12px 14px; text-align:left; position:sticky; top:0; border-bottom:1px solid var(--border-bright); white-space:nowrap; }
  tbody td { padding:10px 14px; border-bottom:1px solid var(--border); vertical-align:top; }
  tbody tr:hover { background:var(--accent-dim); }
  td code { font-family:var(--font-mono); font-size:11px; background:var(--surface2); padding:1px 5px; border-radius:3px; }
  td.yes { color:var(--green); font-weight:600; }
  td.no { color:var(--red); font-weight:600; }
  td.partial { color:var(--amber); font-weight:600; }

  /* Sample data */
  .sample { background:var(--surface2); border:1px solid var(--border); border-radius:10px; padding:20px; margin-bottom:24px; font-size:13px; line-height:1.8; }
  .sample h3 { font-family:var(--font-mono); font-size:12px; color:var(--text-dim); text-transform:uppercase; letter-spacing:1px; margin-bottom:12px; }
  .sample .file { font-family:var(--font-mono); font-size:14px; font-weight:600; color:var(--accent); margin-bottom:8px; }
  .sample .field { color:var(--text-dim); }
  .sample .value { color:var(--text); font-weight:500; }
  .sample .warn { color:var(--amber); }

  @keyframes fadeUp { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
  @media (prefers-reduced-motion: reduce) { * { animation:none !important; } }
</style>
</head>
<body>
<div class="container">

  <h1>Cross-Session Feedback</h1>
  <p class="subtitle">How should genealogy, code similarity, and file history reach the Phase 1 agents?</p>

  <!-- PROBLEM -->
  <div class="callout">
    <strong>The feedback loop gap.</strong> Cross-session data &mdash; 18 genealogy families, 14,176 code similarity matches, 1,379 files indexed across 261 sessions &mdash; is generated at the end of the pipeline but never fed back to the beginning. Each session is analyzed in isolation, as if it's the first one ever processed.
  </div>

  <!-- CURRENT BROKEN FLOW -->
  <div class="flow">
    <div class="flow-step ok">Phase 0</div>
    <div class="flow-arrow">&rarr;</div>
    <div class="flow-step blind">Phase 1 (agents analyze blind)</div>
    <div class="flow-arrow">&rarr;</div>
    <div class="flow-step ok">Phase 2</div>
    <div class="flow-arrow">&rarr;</div>
    <div class="flow-step dead">genealogy + similarity</div>
    <div class="flow-label">&larr; produced here, never fed back</div>
  </div>

  <!-- OPTION A -->
  <div class="sec-head">4 Options</div>

  <div class="option a">
    <h2>Option A: Phase 0.5</h2>
    <span class="tag">Cross-Session Enrichment</span>
    <span class="cost-badge cost-free">$0/session</span>
    <p class="how">New deterministic Python step runs AFTER Phase 0, BEFORE Phase 1. Looks up every file mentioned in the session against existing cross-session data. Produces <code>file_context_brief.json</code> &mdash; one file per session that Phase 1 agents read alongside the tier files.</p>

    <div class="grid">
      <div class="detail-box">
        <h4>What Changes</h4>
        <ul>
          <li>New script: <code>phase_0_prep/cross_session_enricher.py</code></li>
          <li>Reads: <code>cross_session_file_index.json</code></li>
          <li>Reads: <code>cross_session_genealogy.json</code></li>
          <li>Reads: <code>code_similarity_index.json</code></li>
          <li>Writes: <code>file_context_brief.json</code> per session</li>
          <li>Phase 1 agent prompts: "also read file_context_brief.json"</li>
          <li><code>prepare_agent_data.py</code> updated to run this step</li>
        </ul>
      </div>
      <div class="detail-box">
        <h4>Pros &amp; Cons</h4>
        <ul>
          <li class="pro">Clean architecture &mdash; same pattern as Phase 0</li>
          <li class="pro">No agent prompt bloat &mdash; agents read one extra file</li>
          <li class="pro">Works incrementally &mdash; new sessions benefit from all previous analysis</li>
          <li class="pro">High debug visibility &mdash; context is a file on disk you can inspect</li>
          <li class="con">Cold start: first-ever run produces no context (no prior data exists)</li>
          <li class="con">New file and new script to maintain</li>
          <li class="con">3 files modified (enricher + prepare_agent_data + agent prompts)</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- OPTION B -->
  <div class="option b">
    <h2>Option B: Orchestrator Injection</h2>
    <span class="tag">Prompt-Level Context</span>
    <span class="cost-badge cost-low">~$1-2 more/session</span>
    <p class="how">The Phase 1 orchestrator (<code>phase1_redo_orchestrator.py</code>) reads cross-session data at launch time and injects relevant file context directly into each agent's system prompt. No new files created on disk.</p>

    <div class="grid">
      <div class="detail-box">
        <h4>What Changes</h4>
        <ul>
          <li>Modify <code>phase1_redo_orchestrator.py</code> to load 3 indexes</li>
          <li>Extract file-specific context per session</li>
          <li>Append to each agent's system prompt at launch</li>
          <li>No new files on disk</li>
        </ul>
      </div>
      <div class="detail-box">
        <h4>Pros &amp; Cons</h4>
        <ul>
          <li class="pro">No new files &mdash; zero disk footprint</li>
          <li class="pro">Context precisely tailored per agent launch</li>
          <li class="pro">Can filter to only files relevant to this session</li>
          <li class="con">Increases prompt size (more input tokens = higher API cost)</li>
          <li class="con">Orchestrator becomes significantly more complex</li>
          <li class="con">Low debug visibility &mdash; context only exists inside the API call</li>
          <li class="con">Same cold start problem as Option A</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- OPTION C -->
  <div class="option c">
    <h2>Option C: Two-Pass Architecture</h2>
    <span class="tag">Blind First, Enriched Second</span>
    <span class="cost-badge cost-high">2x Phase 1 cost</span>
    <p class="how">First pass runs Phase 1-2 as today (blind). Then a second pass re-runs Phase 1 agents with cross-session context from the first pass plus all prior sessions. Final hyperdocs use second-pass outputs.</p>

    <div class="grid">
      <div class="detail-box">
        <h4>What Changes</h4>
        <ul>
          <li>Add "re-analysis" mode to <code>phase1_redo_orchestrator.py</code></li>
          <li>Second pass agents get first-pass outputs PLUS cross-session data</li>
          <li>Final hyperdocs use second-pass outputs</li>
          <li>1 file modified</li>
        </ul>
      </div>
      <div class="detail-box">
        <h4>Pros &amp; Cons</h4>
        <ul>
          <li class="pro">No cold start problem &mdash; first pass is blind by design</li>
          <li class="pro">Clean separation of concerns</li>
          <li class="pro">Second pass has maximum possible context</li>
          <li class="con">Doubles Phase 1 cost (~$10-20/session extra)</li>
          <li class="con">Doubles processing time</li>
          <li class="con">Only justifiable for high-value sessions</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- OPTION D -->
  <div class="option d">
    <h2>Option D: Enrich at Phase 3</h2>
    <span class="tag">Lazy Cross-Session</span>
    <span class="cost-badge cost-free">$0/session</span>
    <p class="how">Don't change Phase 1 at all. Instead, inject cross-session context at Phase 3 (File Mapper). The File Mapper agent already reads Phase 2 outputs &mdash; add genealogy and similarity data to the file dossier generation step.</p>

    <div class="grid">
      <div class="detail-box">
        <h4>What Changes</h4>
        <ul>
          <li>Modify <code>file-mapper.md</code> agent prompt</li>
          <li>Modify <code>generate_dossiers.py</code> to look up cross-session data</li>
          <li><code>file_dossiers.json</code> gets genealogy + similarity fields</li>
          <li>2 files modified, 0 new files</li>
        </ul>
      </div>
      <div class="detail-box">
        <h4>Pros &amp; Cons</h4>
        <ul>
          <li class="pro">Minimal changes &mdash; fewest files touched</li>
          <li class="pro">No new pipeline step</li>
          <li class="pro">Genealogy and similarity reach final hyperdocs through existing Phase 3 &rarr; 4 path</li>
          <li class="pro">Cheapest path to making disconnected data useful</li>
          <li class="con">Phase 1 agents still analyze blind &mdash; threads, geological, primitives don't benefit</li>
          <li class="con">Enrichment happens late in the pipeline</li>
          <li class="con">Same cold start problem</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- COMPARISON TABLE -->
  <div class="sec-head">Comparison</div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th></th>
          <th>A: Phase 0.5</th>
          <th>B: Orchestrator</th>
          <th>C: Two-Pass</th>
          <th>D: Phase 3</th>
        </tr>
      </thead>
      <tbody>
        <tr><td><strong>New files</strong></td><td>1 script + 1 output</td><td>0</td><td>0</td><td>0</td></tr>
        <tr><td><strong>Files modified</strong></td><td>3</td><td>1</td><td>1</td><td>2</td></tr>
        <tr><td><strong>Cost per session</strong></td><td class="yes">$0</td><td class="partial">~$1-2 more</td><td class="no">~$10-20 (2x)</td><td class="yes">$0</td></tr>
        <tr><td><strong>Phase 1 agents benefit</strong></td><td class="yes">Yes</td><td class="yes">Yes</td><td class="yes">Yes (2nd pass)</td><td class="no">No</td></tr>
        <tr><td><strong>Phase 3 agents benefit</strong></td><td class="yes">Yes (via Phase 1)</td><td class="yes">Yes (via Phase 1)</td><td class="yes">Yes (via Phase 1)</td><td class="yes">Yes (directly)</td></tr>
        <tr><td><strong>Cold start problem</strong></td><td class="partial">Yes</td><td class="partial">Yes</td><td class="yes">No</td><td class="partial">Yes</td></tr>
        <tr><td><strong>Implementation effort</strong></td><td>Medium</td><td>Medium</td><td>Low code, high cost</td><td>Low</td></tr>
        <tr><td><strong>Debug visibility</strong></td><td class="yes">High (file on disk)</td><td class="no">Low (in prompt)</td><td class="yes">High (two outputs)</td><td class="partial">Medium</td></tr>
      </tbody>
    </table>
  </div>

  <!-- RECOMMENDATION -->
  <div class="callout rec">
    <strong>Recommendation:</strong> Option A (Phase 0.5) for maximum impact &mdash; Phase 1 agents get cross-session context, $0 cost, clean architecture. Option D (enrich at Phase 3) as a faster first step that requires fewer changes. They're not mutually exclusive &mdash; <strong>D can ship first</strong> while A is built.
  </div>

  <!-- SAMPLE DATA -->
  <div class="sec-head">What Agents Would See</div>

  <div class="sample">
    <h3>Sample file_context_brief.json entry</h3>
    <div class="file">p01_sentinel.py</div>
    <p><span class="field">Sessions:</span> <span class="value">Seen in 22 previous sessions (most of any file)</span></p>
    <p><span class="field">Genealogy family:</span> <span class="value">P01 LLM Evaluator (35 versions tracked across gate renumbering)</span></p>
    <p><span class="field">Code similarity:</span> <span class="value">87% match with p33_llm_evaluator.py, 82% match with p05_llm_evaluator.py</span></p>
    <p><span class="field">Confidence history:</span> <span class="value">working &rarr; stable &rarr; fragile &rarr; working (oscillating across 4 sessions)</span></p>
    <p><span class="field">Merged warnings:</span> <span class="warn">"bare except blocks" &bull; "overconfident completion claims in 4 sessions" &bull; "model string violation: Sonnet where Opus promised"</span></p>
    <p><span class="field">Key decisions:</span> <span class="value">"chose AST-based detection over regex" &bull; "LLM evaluator replaced with pattern matching"</span></p>
  </div>

  <div class="sample">
    <h3>What changes for an agent analyzing a session that touches p01_sentinel.py</h3>
    <div class="file">Without cross-session context (today)</div>
    <p>Agent sees: this session's messages mentioning p01_sentinel.py. Analyzes in isolation. Doesn't know it's been rewritten 35 times or that bare except blocks are a recurring problem.</p>
    <br>
    <div class="file">With cross-session context (Option A or D)</div>
    <p>Agent sees: this session's messages PLUS "this file oscillates between stable and fragile across 22 sessions, has 35 genealogy variants, and recurring bare-except warnings." Agent can now say: "this edit repeats a pattern seen in 4 previous sessions" instead of treating it as novel.</p>
  </div>

  <div style="text-align:center; margin-top:56px; color:var(--text-dim); font-size:12px; font-family:var(--font-mono);">
    Cross-Session Feedback Design Options &bull; Feb 20, 2026
  </div>

</div>
</body>
</html>
